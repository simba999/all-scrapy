import scrapy
import json
import os
from scrapy.spiders import Spider
from scrapy.http import FormRequest
from scrapy.http import Request
from chainxy.items import ChainItem
from lxml import etree
from selenium import webdriver
from lxml import html
import usaddress
import pdb
import tokenize
import token
from StringIO import StringIO

class fultonfinancial(scrapy.Spider):
	name = 'fultonfinancial'
	domain = ''
	history = []

	def __init__(self):
		script_dir = os.path.dirname(__file__)
		file_path = script_dir + '/geo/US_Cities.json'
		with open(file_path) as data_file:    
			self.location_list = json.load(data_file)

		file_path = script_dir + '/geo/US_States.json'
		with open(file_path) as data_file:
			self.state_list = json.load(data_file)

	def start_requests(self):
		init_url = 'http://locations.fult.com/'
		header = {
			"Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
			"Accept-Encoding":"gzip, deflate",
			"Content-Type":"application/x-www-form-urlencoded"
		}
		for location in self.location_list:
			formdata = {
				"tbCity":location['city'],
				"ddState":self.getState(location['state'], self.state_list),
				"txtZip":'',
				"ddRadius":"20",
				"btbGetZips":"Search",
				"__VIEWSTATEGENERATOR":"CA0B0334",
				"__EVENTVALIDATION":"/wEdAA4fC7Z6WoCNqIbz4YmjwvTwq35qZMbaIVF3xrHN6flGNqao2bLSR+qals4gOttRS9mCJiZhqph59yt0RaIclYwevFEAhQ8JYEI1tOy9r5M2CLHp1NFXlc72kxkb6brsB75tTnm6w0sHh6MK+42Sia7Ncc4szEP+IQOszBwGLLBS+8Mc5rNENOxuAjWq6507F3ljd6s3pTADRMnX9qPei/1YCFN7wsHk06T93CK8RRl0smNbysreGpxSNNz7JAwHQjsr3lQ0UZzzaW2w/Slo/ANYwySc5HpaiDnH01Pws5saK+BJw+m/FLQ2j/uR/2+DyK6GAvt3H9ilE0VZfHwbfDo5",
				"__VIEWSTATE":"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"
			}
			yield scrapy.FormRequest(url=init_url, headers=header, formdata=formdata, method='post', callback=self.body) 

	def body(self, response):
		print("=========  Checking.......")
		with open('response.html', 'wb') as f:
			f.write(response.body)
		try:
			store_list = response.xpath('//table[@class="dataTable"]//tbody//table/tr[1]')
			for store in store_list:
				detail = self.eliminate_space(store.xpath('./td[2]/text()').extract())
				item = ChainItem()
				item['store_name'] = self.validate(store.xpath('./td[2]/b/text()').extract_first())
				item['phone_number'] = ''
				address = ''
				for de in detail:
					if 'Phone:' in de:
						item['phone_number'] = self.validate(de.split('Phone:')[1])
						break
					else:
						address += de + ', '	
				item['address'] = ''
				item['city'] = ''
				addr = usaddress.parse(address)
				for temp in addr:
					if temp[1] == 'PlaceName':
						item['city'] += temp[0].replace(',','')	+ ' '
					elif temp[1] == 'StateName':
						item['state'] = temp[0]
					elif temp[1] == 'ZipCode':
						item['zip_code'] = temp[0].replace(',','')
					else:
						item['address'] += temp[0].replace(',', '') + ' '
				item['country'] = 'United States'
				h_temp = ''
				hour_list = store.xpath('.//td[4]//tr')
				for hour in hour_list:
					if self.validate(hour.xpath('.//td[1]/text()').extract_first()) != '':
						h_temp += self.validate(hour.xpath('.//td[1]/text()').extract_first()) + ' ' + self.validate(hour.xpath('.//td[2]/text()').extract_first()) + ', '
				item['store_hours'] = h_temp[:-2]
				if item['store_name']+item['phone_number'] not in self.history and item['store_name']+item['phone_number'] != '':
					self.history.append(item['store_name']+item['phone_number'])
					yield item			
		except:
			pdb.set_trace()

	def getState(self, key, items):
		for item in items:
			if key in item['name']:
				return item['abbreviation']
		return ''


	def validate(self, item):
		try:
			return item.strip().replace(';','')
		except:
			return ''

	def eliminate_space(self, items):
		tmp = []
		for item in items:
			if self.validate(item) != '':
				tmp.append(self.validate(item))
		return tmp

	def format(self, item):
		try:
			return unicodedata.normalize('NFKD', item).encode('ascii','ignore').strip()
		except:
			return ''

	def fixLazyJson (self, in_text):
		tokengen = tokenize.generate_tokens(StringIO(in_text).readline)
		result = []
		for tokid, tokval, _, _, _ in tokengen:
			if (tokid == token.NAME):
				if tokval not in ['true', 'false', 'null', '-Infinity', 'Infinity', 'NaN']:
					tokid = token.STRING
					tokval = u'"%s"' % tokval
			elif (tokid == token.STRING):
				if tokval.startswith ("'"):
					tokval = u'"%s"' % tokval[1:-1].replace ('"', '\\"')
			elif (tokid == token.OP) and ((tokval == '}') or (tokval == ']')):
				if (len(result) > 0) and (result[-1][1] == ','):
					result.pop()			
			elif (tokid == token.STRING):
				if tokval.startswith ("'"):
					tokval = u'"%s"' % tokval[1:-1].replace ('"', '\\"')
			result.append((tokid, tokval))

		return tokenize.untokenize(result)
